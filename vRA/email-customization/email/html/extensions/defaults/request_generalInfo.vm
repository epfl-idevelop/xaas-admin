## General request info
## This is displayed in "Request information" part of the email.

#if( !$resourceAction || "$!resourceAction" == "" )
  #set( $request_leasePeriod = "#valueOf('requestLeasePeriod')" )
  #if( "$!request_leasePeriod" == "" || "$!request_leasePeriod.trim()" == "" )  
    #set( $requestIsQuoteProvided = $formData.get("${keyPrefix}requestIsQuoteProvided") ) 
    #if( "$!requestIsQuoteProvided" != "" && $requestIsQuoteProvided )  
      #set( $request_leasePeriod = "#msg('notification.email.extensions.request.unlimited')" )
    #end
  #end
#end


## Looking for data we need to build mail

## This var is created with the same name as Java library so we can use it with methods defined here:
## https://velocity.apache.org/engine/1.7/apidocs/org/apache/velocity/util/StringUtils.html
#set($String = "")

## If it's not a XaaS request, info is in "Details"
#set( $form_url = $formData.get("Details") )
#if ( "$form_url" == "")
  #customDebug("Looking in workItemShellUrl")
  ## Info is not in "Details" so it's a XaaS request so we look into "workItemShellUrl"
  #set( $form_url = $formData.get("workItemShellUrl") )
#end

#customDebug("Form URL: ${form_url}")

## $form_url will now contains something like this:
## https://vsissp-vra-test.epfl.ch/vcac/org/EPFL/#csp.cs.ui.deployment.detail%5BrouteParams:=27e3f681-61c0-41dd-8c80-27f2d7e8123e

#set($parts = $String.split($form_url, "/") )
#customDebug("Index 1: ${parts[5]}")
##set($form_url = $form_url.substring($index + 10) )
##customDebug("Form URL 2: ${form_url}")
##set($index = $form_url.indexOf("/") )
##customDebug("Index 2: ${index}")
##set($tenant_name = $form_url.substring(0, $index) )
##customDebug("Tenant : ${tenant_name}")

#set($tenant_name = "EPFL" )

<h2>#msg("notification.email.extensions.request.info") </h2>
<br/>

##This is special case handling for scale-out/In emails, they have different template than regualar action emails.
#if( $resourceAction == "{com.vmware.csp.component.cafe.composition@resource.action.deployment.scaleout.name}")
    #parse( 'extensions/request_scaleOutAction.vm' )
#end

#if( $resourceAction == "{com.vmware.csp.component.cafe.composition@resource.action.deployment.scalein.name}")
    #parse( 'extensions/request_scaleInAction.vm' )
#end

## Adding Scenario ID in email, just to help to develop things
<!-- Scenario: $scenario -->

<table class="sectionGrid">
  #renderRowNoLabelMapping("Tenant", $tenant_name)
  
  #if ( $tenant_name == "EPFL" )
    #renderRowComponent("Unit ID", $keyPrefix, "ch.epfl.unit.id" )
  #else
    #renderRowComponent("ServiceNow svc ID", $keyPrefix, "ch.epfl.snow.svc.id" )
  #end
  
  #renderRow("notification.email.extensions.deployment", "#valueOf('catalogItem-Name')")
  #renderRow("notification.email.extensions.action", $resourceAction_Name)
  #renderRow("notification.email.extensions.request.requestedBy", "#valueOf('requestedBy')")
  #renderRowNoLabelMapping("Requested for email address", $formData.get("${keyPrefix}provider-ch.epfl.owner_mail"))
  #renderRow("notification.email.extensions.request.requestDate", "#valueOf('requestedDate')")
  #renderRow("notification.email.extensions.description", "#valueOf('description')")
  #renderRow("notification.email.extensions.request.reason", "#valueOf('reasons')")
  #renderRow("notification.email.extensions.request.numberOfInstances", "#valueOf('_number_of_instances')")
  #renderRowComponent("DMZ", $keyPrefix, "ch.epfl.iaas.dmz.enabled" )
  #renderRow("notification.email.extensions.request.estimatedLeasePrice", "#valueOf('requestLeaseCost')")
  #renderRow("notification.email.extensions.request.leasePeriod", $request_leasePeriod)
  #renderRow("notification.email.extensions.request.totalPrice", "#valueOf('requestTotalLeaseCost')")
